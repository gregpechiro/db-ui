<!DOCTYPE html>
<html>
	<head>
		<script src="//code.jquery.com/jquery-2.1.3.min.js"></script>
		<script src="//code.jquery.com/ui/1.11.2/jquery-ui.min.js"></script>
		<link rel="stylesheet" href="//code.jquery.com/ui/1.11.2/themes/smoothness/jquery-ui.css">
		<style type="text/css">
			.editable { padding: 10px; float: left; margin: 0 10px 10px 0; border:1px solid red;}
		</style>
		<title>Test</title>
	</head>
	<body>
		<br><br>
		<div>
			<button id="cler">Clear</button>
			<button id="fill">Fill</button>
			<button id="add">Add</button>
		</div>

		<div id="content"></div>

		<div id="editModal">
			<form id="editForm">
				<label>Type</label>
				<select id="type" name="type">
					<option value="form">Form</option>
					<option value="table">Table</option>
				</select>
				<label>Object</label>
				<input type="text" style="width:45%" id="resource" name="resource" value="">
				<br><br>
				<div id="all-options">
					<label>Fields</label>
					<div id="option0">
						<span name="option">
							<input id="option0" type="text" name="fields" class="width-50" placeholder="Name">
							<select id="option0" class="width-25">
								<option value="text">Text</option>
								<option value="number">Number</option>
								<option value="boolean">Boolean</option>
							</select>
						</span>
					</div>
				</div>
			</form>
		</div>

		<div id="next-option-input" hidden="true">
			<div id="add-option" class="extra">
				<span name="option">
					<input type="text" name="fields" class="width-50" placeholder="Name">
					<select name="type" class="width-25">
						<option value="text">Text</option>
						<option value="number">Number</option>
						<option value="boolean">Boolean</option>
					</select>
					<a href="" name="remove-option">x</a>
				</span>
			</div>
		</div>

		<div id="next-option-div" hidden="true">
			<div id="add-option" class="extra"></div>
		</div>

		<script type="text/javascript" id="code">

			var components = {};
			var editing;
			var i = 0;
			var addOptionDiv = 'div[id="all-options"] div[id="add-option"]';
			var count = 1;
			//var specs = {};

			function addOption(field) {
				field = (field === undefined) ? {type:'text'} : field;
				$('form[id="editForm"] div[id="all-options"]').append($('div[id="next-option-input"]').html());
				$('form[id="editForm"] ' + addOptionDiv).attr('id', 'option' + count);
				$('form[id="editForm"] div[id="option' + count + '"] input').attr('id', 'option' + count).val(field.name);
				$('form[id="editForm"] div[id="option' + count + '"] select').attr('id', 'option' + count).val(field.type);
				$('form[id="editForm"] div[id="option' + count + '"] a').attr('id', 'option' + count);
				$('form[id="editForm"] a[id="option' + count + '"]').click(function(e) {
					e.preventDefault();
					$('form[id="editForm"] div[id="'+$(this).attr('id')+'"]').remove();
				});
				count++;
			}

			function resetEditForm() {
				$('form[id="editForm"] div.extra').remove();
				$('form[id="editForm"] input[id="option0"]').val('');
				$('form[id="editForm"] select[id="option0"]').val('text');
				$('form[id="editForm"] input[id="resource"]').val('');
				$('form[id="editForm"] select[id="type"]').val('form');
				count = 1;
			}

			function getEditForm() {
				var component = {};
    			component['type'] = $('form[id="editForm"] select[id="type"]').val();
    			component['resource'] = $('form[id="editForm"] input[id="resource"]').val();
    			var data = [];
    			if (component['type'] != 'iframe') {
        			var spans = $('form[id="editForm"] div[id="all-options"] span[name="option"]');
        			for (var i = 0; i < spans.length; i++) {
            			var dat = {};
            			dat['name'] = spans[i].children[0].value;
            			dat['type'] = spans[i].children[1].value;
            			data.push(dat);
        			}
    			}
				component['fields'] = data;
				return component;
			}

			function generateTable(entities) {
				var table = '';
				table += '<table style="width:100%;"><thead><tr>';
				for(var col in entities[0]) {
				   table += "<th>" + col + "</th>";
				}
				table += '</tr></thead><tbody>';
				for(var row in entities) {
					table += '<tr>';
					for(var col in entities[row]) {
						table += "<td>" + entities[row][col] + "</td>";
					}
					 table += '</tr>';
				}
				table += '</tbody></table>';
				return table;
			}


			function generateForm(component, live) {
				var form = '<form>';
				for(var field in component.fields) {
					if (live) {
						form += '<input style="width:100%;" placeholder="' + title(component.fields[field].name) +
						'" name="' + component.fields[field].name + '" value="{{' + component.resource + '.' + component.fields[field].name + '}}">';
					} else {
						form += '<input style="width:100%;" placeholder="' + title(component.fields[field].name) + '">';
					}
				}
				form += '<button style="width:100%;">Save</button>';
				form += '</form>';
				return form;
			}

			function display(data) {
				var spans = pageGen(data, false).children();
				spans.addClass('editable');
				$('#content').append(spans);
				init();
			}

			function pageGen(data, live) {
				var div = $('<div></div>');
				for(var id in data) {
					var component = data[id]
					var type = data[id].type;
					var span = $('<span style="position:absolute;"></span>');
					span.attr('id', id);
					span.css({top: component.top,left:component.left,height:component.height,width:component.width});
					switch(type) {
						case "table":
							getData(component.action, generateTable, span);
							break;
						case "form":
							span.html(generateForm(component, live));
							break;
						default:
							alert("type: " + type + ", action: " + action);
					}
					div.append(span);
				}
				//console.log('<!doctype html><html><head></head><body>' + div.prop('outerHTML') + '</body></html>');
				return div;
			}

			function getPage() {
				console.log('<!doctype html><html><head></head><body>' + pageGen(components, true).prop('outerHTML') + '</body></html>');
			}

			function add(component) {
				var span = $('<span class="editable" style="position:absolute; width:300px"></span>');
				components[i] = component;
				span.attr('id', i);
				span.css({top: component.top, left: component.left, height: component.height, width: component.width});
				switch(component.type) {
					case "table":
						console.log("TABLE");
						break;
					case "form":
						span.html(generateForm(component));
						break;
					default:
						alert("type: " + type + ", action: " + action);
				}
				$('#content').append(span);
				i++;
				init();
			}

			function init() {
				$('.editable').draggable({
					grid: [ 35, 35 ],
					stop: function( event, ui ) {savePosition(ui);}
				});
				$('.editable' ).resizable({
					grid: [ 35, 35 ],
					stop: function( event, ui ) {saveSize(ui)}
				});
				$('.editable').click(function() {
					edit(this.id);
				});
			}

			function saveSize(ui) {
				components[ui.helper[0].id].height = ui.size.height;
				components[ui.helper[0].id].width = ui.size.width;
			}

			function savePosition(ui) {
				components[ui.helper[0].id].left = ui.position.left
				components[ui.helper[0].id].top = ui.position.top
			}

			$(document).ready(function() {
				init();
				$('#editModal').dialog({
					title : 'Add',
					position: { my: "right	 top", at: "right top", of: window },
					width: 375,
					maxHeight: 550,
					buttons: [
						{
      						text: "Add Option",
      						click: function() {
								addOption();
							}
      					},
						{
							text: "Save",
							click: function() {
								var component = getEditForm();
								if (editing != null) {
									component.height = components[editing].height
									component.width = components[editing].width
									component.left = components[editing].left
									component.top = components[editing].top
								}
								add(component);
								deleteComponent(editing);
							}
						},
						{
							text: "Cancel",
							click: function() {
								deleteComponent(editing);
							}
						}
					]
				});
			});

			function deleteComponent(id) {
				$('span[id="' + id + '"]').remove();
				$('#editModal').dialog('option', 'title', 'Add');
				delete components[id];
				editing = null;
				resetEditForm();
				var buttons = $('#editModal').dialog('option', 'buttons');
				buttons[2].text = "Cancel";
				$('#editModal').dialog('option', 'buttons', buttons);
			}

			function edit(id) {
				editing = id;
				component = components[id];
				resetEditForm();
				$('#editForm select[id="type"]').val(component.type);
				$('#editForm input[id="resource"]').val(component.resource);
				$('#editForm input[id="option0"]').val(component.fields[0].name);
				$('#editForm select[id="option0"]').val(component.fields[0].type);
				for (var i = 1; i < component.fields.length; i++) {
					addOption(component.fields[i]);
				}
				$('#editModal').dialog('option', 'title', 'Editing Span: ' + editing);
				var buttons = $('#editModal').dialog('option', 'buttons');
				buttons[2].text = "Delete";
				$('#editModal').dialog('option', 'buttons', buttons);
				$('#editModal').dialog('open');
			}

			$('button[id="add"]').click(function() {
				editing = null;
				resetEditForm();
				var buttons = $('#editModal').dialog('option', 'buttons');
				buttons[2].text = "Cancel";
				$('#editModal').dialog('option', 'buttons', buttons);
				$('#editModal').dialog('option', 'title', 'Add');
				$('div[id="editModal"]').dialog('open');
			});

			$('button[id="cler"]').click(function() {
				$('div[id="content"]').html('');
			});

			$('button[id="fill"]').click(function() {
				display(components);
			});

			function title(s) {
				var cap = false;
				var newS = s[0].toUpperCase();
				for (var i = 1; i < s.length; i++) {
					if (cap) {
						newS += s[i].toUpperCase();
						cap = false;
					} else if (s[i] === '-' || s[i] === '_') {
						newS += ' ';
						cap = true;
					} else if (s[i] === s[i].toUpperCase()) {
						newS += ' ' + s[i];
					} else {
						newS += s[i];
					}
				}
				return newS;
			}


		</script>

	</body>
</html>
